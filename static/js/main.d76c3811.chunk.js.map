{"version":3,"sources":["redux.js","components/Timetable.js","components/StopInfo.js","App.js","index.js"],"names":["getCurrentPosition","options","arguments","length","undefined","Promise","resolve","reject","navigator","geolocation","composeEnhancers","window","compose","createStore","state","action","type","Object","objectSpread","loading","nearbyTimetables","payload","stopsByRadius","edges","map","edge","node","stop","distance","response","swipeStatus","applyMiddleware","thunk","TimetableList","styled","ul","_templateObject","Timetable","_ref","stoptimes","now","Date","nextStops","stoptime","react_default","a","createElement","key","realtimeArrival","concat","trip","routeShortName","headsign","arrivalTime","departureTimestamp","departureDate","secondsSinceMidnight","Math","floor","getTime","max","calculateArrivalMinutes","serviceDay","StopInfoWrapper","article","StopInfo_templateObject","StopName","h2","_templateObject2","Desc","h3","_templateObject3","StopInfo","stopInfo","name","code","desc","components_Timetable","stoptimesWithoutPatterns","GlobalStyle","createGlobalStyle","App_templateObject","Map","ReactMapboxGl","accessToken","ReactRedux","dispatch","fetchNearbyTimetables","asyncToGenerator","regenerator_default","mark","_callee","urlStr","url","lat","lon","radius","position","query","wrap","_context","prev","next","location","href","URL","searchParams","get","console","log","sent","coords","latitude","longitude","parseFloat","graphqlRequest","then","data","catch","error","finally","_x","apply","this","props","zoom","React","useEffect","_React$useState","useState","_React$useState2","slicedToArray","stopPopup","setStopPopup","style","containerStyle","height","width","center","onClick","lib_esm","id","paint","circle-radius","circle-color","coordinates","layout","icon-image","icon-size","gtfsId","components_StopInfo","ReactDOM","render","es","store","src_App","document","getElementById"],"mappings":"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","file":"static/js/main.d76c3811.chunk.js","sourcesContent":["import { createStore, applyMiddleware, compose } from \"redux\";\nimport { request as graphqlRequest } from \"graphql-request\";\nimport thunk from \"redux-thunk\";\n\nconst SWIPE_RIGHT = \"SWIPE_RIGHT\";\nconst SWIPE_LEFT = \"SWIPE_LEFT\";\nconst FETCH_START = \"FETCH_START\";\nconst FETCH_SUCCESS = \"FETCH_SUCCESS\";\nconst LOCATION_UPDATED = \"LOCATION_UPDATED\";\n\nfunction getCurrentPosition(options = {}) {\n  return new Promise((resolve, reject) => {\n    navigator.geolocation.getCurrentPosition(resolve, reject, options);\n  });\n}\n\nexport const fetchNearbyTimetables = () => async dispatch => {\n  dispatch({ type: FETCH_START });\n\n  const urlStr = window.location.href;\n  const url = new URL(urlStr);\n\n  let lat = url.searchParams.get(\"lat\");\n  let lon = url.searchParams.get(\"lon\");\n  let radius = url.searchParams.get(\"radius\");\n\n  if (!lat || !lon) {\n    console.log(\"geolocation start\");\n    const position = await getCurrentPosition();\n    console.log(\"geolocation end\", position);\n    lat = position.coords.latitude;\n    lon = position.coords.longitude;\n  } else {\n    lat = parseFloat(lat);\n    lon = parseFloat(lon);\n  }\n\n  if (!radius) {\n    radius = 500;\n  }\n\n  dispatch({ type: LOCATION_UPDATED, payload: { lat, lon } });\n\n  const query = `{\n    stopsByRadius(lat:${lat}, lon:${lon}, radius:${radius}) {\n      edges {\n        node {\n          stop {\n            gtfsId\n            name\n            code\n            desc\n            lat\n            lon\n              stoptimesWithoutPatterns {\n              scheduledArrival\n              realtimeArrival\n              arrivalDelay\n              scheduledDeparture\n              realtimeDeparture\n              departureDelay\n              realtime\n              realtimeState\n              serviceDay\n              headsign\n              trip {\n                routeShortName\n                directionId\n              } \n            }\n          }\n          distance\n        }\n      }\n    }\n  }`;\n\n  console.log(\"query start\");\n\n  graphqlRequest(\n    \"https://api.digitransit.fi/routing/v1/routers/hsl/index/graphql\",\n    query\n  )\n    .then(data => dispatch({ type: FETCH_SUCCESS, payload: data }))\n    .catch(error => console.log(error))\n    .finally(() => console.log(\"query end\"));\n};\n\n// export const swipeRight = () => ({\n//   type: SWIPE_RIGHT\n// });\n//\n// export const swipeLeft = () => ({\n//   type: SWIPE_LEFT\n// });\n\nconst reducer = (state, action) => {\n  switch (action.type) {\n    case FETCH_START:\n      return { ...state, loading: true };\n    case FETCH_SUCCESS:\n      return {\n        ...state,\n        loading: false,\n        nearbyTimetables: action.payload.stopsByRadius.edges.map(edge => ({\n          ...edge.node.stop,\n          distance: edge.node.distance\n        }))\n      };\n    case LOCATION_UPDATED:\n      return {\n        ...state,\n        geolocation: action.payload\n      };\n\n    default:\n      return state;\n  }\n};\n\n// Create redux store.\nconst composeEnhancers =\n  window[\"__REDUX_DEVTOOLS_EXTENSION_COMPOSE__\"] || compose;\nexport default createStore(\n  reducer,\n  { loading: false, response: null, swipeStatus: \"INITIAL\" },\n  composeEnhancers(applyMiddleware(thunk))\n);\n","import React from \"react\";\nimport styled from \"styled-components\";\n\nconst TimetableList = styled.ul`\n  list-style: none;\n  padding-left: 0;\n\n  li {\n    padding: 5px 0;\n    font-weight: normal;\n  }\n`;\n\nconst Timetable = ({ stoptimes }) => {\n  const now = new Date();\n\n  const calculateArrivalMinutes = (arrivalTime, departureTimestamp) => {\n    const departureDate = new Date(departureTimestamp * 1000);\n    const secondsSinceMidnight = Math.floor(\n      (now.getTime() - departureDate.getTime()) / 1000\n    );\n    return Math.max(Math.floor((arrivalTime - secondsSinceMidnight) / 60), 0);\n  };\n\n  const nextStops = stoptimes.map(stoptime => (\n    <li key={stoptime.realtimeArrival}>{`${stoptime.trip.routeShortName} ${\n      stoptime.headsign\n    } (${calculateArrivalMinutes(\n      stoptime.realtimeArrival,\n      stoptime.serviceDay\n    )} min)`}</li>\n  ));\n\n  return <TimetableList>{nextStops}</TimetableList>;\n};\n\nexport default Timetable;\n","import React from \"react\";\nimport styled from \"styled-components\";\n\nimport Timetable from \"./Timetable\";\n\nconst StopInfoWrapper = styled.article`\n  vertical-align: top;\n`;\n\nconst StopName = styled.h2`\n  margin: 0.5em 0 0.5em 0;\n  font-weight: normal;\n`;\n\nconst Desc = styled.h3`\n  margin: 0 0 1em 0;\n`;\n\nconst StopInfo = ({ stopInfo }) => {\n  return (\n    <StopInfoWrapper>\n      <StopName>{`${stopInfo.name}, ${\n        stopInfo.code\n      } (${stopInfo.distance} m)`}</StopName>\n      <Desc>{stopInfo.desc}</Desc>\n      <Timetable stoptimes={stopInfo.stoptimesWithoutPatterns} />\n    </StopInfoWrapper>\n  );\n};\n\nexport default StopInfo;\n","import React from \"react\";\nimport styled, { createGlobalStyle } from \"styled-components\";\nimport ReactMapboxGl, { Layer, Feature, Popup } from \"react-mapbox-gl\";\n\nimport * as ReactRedux from \"react-redux\";\nimport { fetchNearbyTimetables } from \"./redux\";\n\nimport StopInfo from \"./components/StopInfo.js\";\n\nconst GlobalStyle = createGlobalStyle`\n  html {\n    background-color: lightgray;\n  }\n\n  body {\n    margin: 0;\n    font-family: sans-serif;\n    font-weight: bold;\n  }\n`;\n\nconst Map = ReactMapboxGl({\n  accessToken:\n    \"pk.eyJ1Ijoic2FrYXN1dGUtYWxtYSIsImEiOiJjanZ4aGc2OG8wNHM3NDNycnNyNTBhOThlIn0.70Nsp4cpsqajXtCLiFS5aA\"\n});\n\nfunction App(props) {\n  const {\n    geolocation,\n    nearbyTimetables,\n    loading,\n    fetchNearbyTimetables\n  } = props;\n\n  const urlStr = window.location.href;\n  const url = new URL(urlStr);\n  let zoom = url.searchParams.get(\"zoom\");\n  if (!zoom) {\n    zoom = 15.5\n  }\n\n  React.useEffect(() => {\n    fetchNearbyTimetables();\n  }, [fetchNearbyTimetables]);\n\n  const [stopPopup, setStopPopup] = React.useState(null);\n  return (\n    <main>\n      <GlobalStyle />\n      {loading || !nearbyTimetables ? (\n        <p>loading...</p>\n      ) : (\n        <Map\n          style=\"mapbox://styles/mapbox/light-v9\"\n          containerStyle={{\n            height: \"100vh\",\n            width: \"100vw\"\n          }}\n          center={[geolocation.lon, geolocation.lat]}\n          zoom={[zoom]}\n          onClick={() => setStopPopup(null)}\n        >\n          <Layer\n            type=\"circle\"\n            id=\"geolocation\"\n            paint={{ \"circle-radius\": 15, \"circle-color\": \"#ff512c\" }}\n          >\n            <Feature coordinates={[geolocation.lon, geolocation.lat]} />\n          </Layer>\n          <Layer\n            type={\"symbol\"}\n            id=\"stops\"\n            layout={{ \"icon-image\": \"bus-15\", \"icon-size\": 1.5 }}\n          >\n            {nearbyTimetables.map(stop => {\n              return (\n                <Feature key={stop.gtfsId} coordinates={[stop.lon, stop.lat]} onClick={() => setStopPopup(stop)} />\n              );\n            })}\n          </Layer>\n          {stopPopup && (\n            <Popup\n              coordinates={[stopPopup.lon, stopPopup.lat]}\n            >\n              <StopInfo\n                key={stopPopup.gtfsId}\n                stopInfo={stopPopup}\n              />\n            </Popup>\n          )}\n        </Map>\n      )}\n    </main>\n  );\n}\n\nconst mapStateToProps = state => ({\n  nearbyTimetables: state.nearbyTimetables,\n  loading: state.loading,\n  geolocation: state.geolocation\n});\n\nconst mapDispatchToProps = dispatch => ({\n  fetchNearbyTimetables: () => dispatch(fetchNearbyTimetables())\n});\n\nexport default ReactRedux.connect(mapStateToProps, mapDispatchToProps)(App);\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\n\nimport App from \"./App\";\n\nimport { Provider } from \"react-redux\";\nimport store from \"./redux\";\n\nReactDOM.render(\n    <Provider store={store}>\n        <App />\n    </Provider>,\n    document.getElementById(\"root\")\n);\n"],"sourceRoot":""}